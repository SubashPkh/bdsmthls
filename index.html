<!DOCTYPE html>
<html>
<head>
    <title>Monthly Log Sheet</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f4f7f6; /* Very light grey background */
        }
        h1, h2 {
            text-align: center;
            color: #37474f; /* Dark grey heading text */
        }
        h1 {
            margin-bottom: 0.5em;
        }
        h2 {
            margin-top: 0;
        }
        #monthlyLogForm {
            margin-bottom: 2em; /* Increased margin at the bottom */
            padding: 1em;
            border: 1px solid #e0e0e0; /* Light grey border */
            border-radius: 5px;
            background-color: #fff; /* White form background */
        }
        #monthlyLogForm > div {
            margin-bottom: 0.75em;
        }
        #monthlyLogForm label {
            display: inline-block;
            width: 150px;
            text-align: left;
            margin-right: 0.5em;
            color: #546e7a; /* Medium grey label text */
        }
        #monthlyLogForm select,
        #monthlyLogForm input[type="text"] {
            width: 200px;
            padding: 0.3em;
            border: 1px solid #b0bec5; /* Light blue-grey border for inputs */
            border-radius: 3px;
            color: #37474f; /* Dark grey input text */
        }
        #indicators table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            background-color: #fff; /* White table background */
            border-radius: 5px;
            overflow: hidden; /* To contain the border-radius for thead */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }
        #indicators thead {
            background-color: #eceff1; /* Very light grey for header */
            color: #546e7a; /* Medium grey header text */
        }
        #indicators th, #indicators td {
            border: 1px solid #e0e0e0; /* Light grey border for cells */
            padding: 0.75em 0.5em;
            text-align: center;
            color: #37474f; /* Dark grey cell text */
        }
        #indicators th {
            font-weight: bold;
        }
        #indicators input[type="text"] { /* Changed input type to text */
            width: 70px;
            padding: 0.3em;
            border: 1px solid #b0bec5; /* Light blue-grey border for number inputs */
            border-radius: 3px;
            color: #37474f; /* Dark grey input text */
            background-color: #f8f8f8; /* Very light grey input background */
            text-align: center; /* Center the text inside the input */
        }
        #indicators input[type="text"].error {
            border-color: red;
            background-color: #ffebee; /* Light red background for error */
        }
        #indicators input[type="text"].edited {
            border-color: orange;
            background-color: #fffde7; /* Light yellow background for edited */
        }
        #indicators .readonly {
            background-color: #e8f5e9; /* Light green for readonly */
            color: #388e3c; /* Dark green for readonly text */
        }
        #indicators td:first-child + td { /* Target the Indicator column */
            text-align: left;
        }
        #indicators tbody tr:nth-child(even) {
            background-color: #f9fbe7; /* Very light yellow for even rows */
        }
        #indicators tbody tr:hover {
            background-color: #f0f4c3; /* Slightly darker light yellow on hover */
        }
        #formActions {
            text-align: center;
            margin-top: 20px;
        }
        #formActions button {
            padding: 0.7em 1.5em;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #submitBtn {
            background-color: #4caf50; /* Green submit button */
        }
        #submitBtn:hover {
            background-color: #388e3c;
        }
        #editBtn, #updateBtn {
            background-color: #2196f3; /* Blue edit/update button */
        }
        #editBtn:hover, #updateBtn:hover {
            background-color: #1976d2;
        }
        #downloadBtn {
            background-color: #ff9800; /* Orange download button */
        }
        #downloadBtn:hover {
            background-color: #f57c00;
        }
        #submitBtn:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }
        #editLog {
            margin-top: 20px;
            padding: 1em;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #f9fbe7; /* Light yellow for edit log */
            display: none; /* Initially hidden */
        }
        #editLog h3 {
            color: #546e7a;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>BDS HIV Community Services</h1>
    <h2>Monthly Log Sheet</h2>
    <form id="monthlyLogForm">
        <div>
            <label for="district">Select District:</label>
            <select id="district">
                <option value="" disabled selected>Select District</option>
                <option value="Bara">Bara</option>
                <option value="Bardiya">Bardiya</option>
                <option value="Bhaktapur">Bhaktapur</option>
                <option value="Dang">Dang</option>
                <option value="Dhanusa">Dhanusa</option>
                <option value="Jhapa">Jhapa</option>
                <option value="Kanchanpur">Kanchanpur</option>
                <option value="Kapilvastu">Kapilvastu</option>
                <option value="Kathmandu">Kathmandu</option>
                <option value="Mahottari">Mahottari</option>
                <option value="Makawanpur">Makawanpur</option>
                <option value="Morang">Morang</option>
                <option value="Nawalparasi East">Nawalparasi East</option>
                <option value="Nawalparasi West">Nawalparasi West</option>
                <option value="Parsa">Parsa</option>
                <option value="Rautahat">Rautahat</option>
                <option value="Rupandehi">Rupandehi</option>
                <option value="Saptari">Saptari</option>
                <option value="Sarlahi">Sarlahi</option>
                <option value="Siraha">Siraha</option>
                <option value="Sunsari">Sunsari</option>
            </select>
        </div>
        <div>
            <label for="subPartner">Sub-Partner's Name:</label>
            <select id="subPartner">
                <option value="" disabled selected>Select Sub-Partner</option>
            </select>
        </div>
        <div>
            <label for="reportingYear">Reporting Year:</label>
            <select id="reportingYear">
                <option value="" disabled selected>Select Year</option>
                <option value="Year1">Year1 (April 2025 - March 2026)</option>
                <option value="Year2">Year2 (April 2026 - March 2027)</option>
                <option value="Year3">Year3 (April 2027 - March 2028)</option>
                <option value="Year4">Year4 (April 2028 - March 2029)</option>
            </select>
        </div>
        <div>
            <label for="reportingMonth">Reporting Month:</label>
            <select id="reportingMonth" disabled>
                <option value="" disabled selected>Select Month</option>
            </select>
        </div>

        <div id="indicators">
            <table>
                <thead>
                    <tr>
                        <th>S. No.</th>
                        <th>Indicator</th>
                        <th>Establishment based FSW</th>
                        <th>Home based FSW</th>
                        <th>Street based FSW</th>
                        <th>Virtual FSW</th>
                        <th>Sub-Total FSW</th>
                        <th>MSM</th>
                        <th>MSW</th>
                        <th>Sub-Total MSM</th>
                        <th>TG Non SW</th>
                        <th>TG SW</th>
                        <th>Sub-Total TG</th>
                        <th>Other Male</th>
                        <th>Other Female</th>
                        <th>Sub-Total PP</th>
                        <th>Grand Total</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="formActions">
            <button type="submit" id="submitBtn">Submit Log Sheet</button>
            <button type="button" id="editBtn" style="display: none;">Edit</button>
            <button type="button" id="updateBtn" style="display: none;">Update</button>
            <button type="button" id="downloadBtn" style="display: none;">Download (Excel)</button>
        </div>

        <div id="editLog">
            <h3>Edit Log</h3>
            <ul id="editLogList">
            </ul>
        </div>
    </form>

    <script>
        const districtSelect = document.getElementById('district');
        const subPartnerSelect = document.getElementById('subPartner');
        const reportingYearSelect = document.getElementById('reportingYear');
        const reportingMonthSelect = document.getElementById('reportingMonth');
        const monthlyLogForm = document.getElementById('monthlyLogForm');
        const indicatorsTableBody = document.querySelector('#indicators tbody');
        const submitBtn = document.getElementById('submitBtn');
        const editBtn = document.getElementById('editBtn');
        const updateBtn = document.getElementById('updateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const formActions = document.getElementById('formActions');
        const editLogDiv = document.getElementById('editLog');
        const editLogList = document.getElementById('editLogList');

        const districtSubPartners = {
            Bara: ['Blue Heaven Nepal'],
            Bardiya: ['Sundar Sansar'],
            Bhaktapur: ['Our Equal Access'],
            Dang: ['Human Health Society'],
            Dhanusa: ['Sunaulo Bihan Samaj'],
            Jhapa: ['Lead Nepal'],
            Kanchanpur: ['Sahayatra Nepal'],
            Kapilvastu: ['Nava Jeevan'],
            Kathmandu: ['Cruiseaids Nepal'],
            Mahottari: ['Chautari Nepal'],
            Makawanpur: ['Friends Hetauda'],
            Morang: ['Pariwartanshil Samaj'],
            'Nawalparasi East': ['Empowerment Nepal'],
            'Nawalparasi West': ['Empowerment Nepal'],
            Parsa: ['Sahayatri Samaj'],
            Rautahat: ['Saptarangi Samaj'],
            Rupandehi: ['Mono Supportive Group'],
            Saptari: ['Sahayogi Samaj Nepal'],
            Sarlahi: ['Pahichan Nepal'],
            Siraha: ['Jeevan Jyoti Samaj'],
            Sunsari: ['Human Welfare Society']
        };

        const yearMonths = {
            Year1: [
                { value: 'April-2025', label: 'April 2025' },
                { value: 'May-2025', label: 'May 2025' },
                { value: 'June-2025', label: 'June 2025' },
                { value: 'July-2025', label: 'July 2025' },
                { value: 'August-2025', label: 'August 2025' },
                { value: 'September-2025', label: 'September 2025' },
                { value: 'October-2025', label: 'October 2025' },
                { value: 'November-2025', label: 'November 2025' },
                { value: 'December-2025', label: 'December 2025' },
                { value: 'January-2026', label: 'January 2026' },
                { value: 'February-2026', label: 'February 2026' },
                { value: 'March-2026', label: 'March 2026' }
            ],
            Year2: [
                { value: 'April-2026', label: 'April 2026' },
                { value: 'May-2026', label: 'May 2026' },
                { value: 'June-2026', label: 'June 2026' },
                { value: 'July-2026', label: 'July 2026' },
                { value: 'August-2026', label: 'August 2026' },
                { value: 'September-2026', label: 'September 2026' },
                { value: 'October-2026', label: 'October 2026' },
                { value: 'November-2026', label: 'November 2026' },
                { value: 'December-2026', label: 'December 2026' },
                { value: 'January-2027', label: 'January 2027' },
                { value: 'February-2027', label: 'February 2027' },
                { value: 'March-2027', label: 'March 2027' }
            ],
            Year3: [
                { value: 'April-2027', label: 'April 2027' },
              	{ value: 'May-2027', label: 'May 2027' },
                { value: 'June-2027', label: 'June 2027' },
                { value: 'July-2027', label: 'July 2027' },
                { value: 'August-2027', label: 'August 2027' },
                { value: 'September-2027', label: 'September 2027' },
                { value: 'October-2027', label: 'October 2027' },
                { value: 'November-2027', label: 'November 2027' },
                { value: 'December-2027', label: 'December 2027' },
                { value: 'January-2028', label: 'January 2028' },
                { value: 'February-2028', label: 'February 2028' },
                { value: 'March-2028', label: 'March 2028' }
            ],
            Year4: [
                { value: 'April-2028', label: 'April 2028' },
                { value: 'May-2028', label: 'May 2028' },
                { value: 'June-2028', label: 'June 2028' },
                { value: 'July-2028', label: 'July 2028' },
                { value: 'August-2028', label: 'August 2028' },
                { value: 'September-2028', label: 'September 2028' },
                { value: 'October-2028', label: 'October 2028' },
                { value: 'November-2028', label: 'November 2028' },
                { value: 'December-2028', label: 'December 2028' },
                { value: 'January-2029', label: 'January 2029' },
                { value: 'February-2029', label: 'February 2029' },
                { value: 'March-2029', label: 'March 2029' }
            ]
        };

        // Assuming a more complete structure for indicatorsData
        const indicatorsData = [
            {
                "indicator": "Number of new people contacted in HIV prevention",
                "columns": ["establishment_fsw", "home_fsw", "street_fsw", "virtual_fsw", "msm", "msw", "tg_non_sw", "tg_sw", "other_male", "other_female"]
            },
            {
                "indicator": "Number of condoms distributed",
                "columns": ["establishment_fsw", "home_fsw", "street_fsw", "virtual_fsw", "msm", "msw", "tg_non_sw", "tg_sw", "other_male", "other_female"]
            },
            // Add more indicator data here as needed
        ];

        function populateSubPartners(district) {
            subPartnerSelect.innerHTML = '<option value="" disabled selected>Select Sub-Partner</option>';
            if (district && districtSubPartners[district]) {
                districtSubPartners[district].forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner;
                    option.textContent = partner;
                    subPartnerSelect.appendChild(option);
                });
            }
        }

        function populateMonths(year) {
            reportingMonthSelect.innerHTML = '<option value="" disabled selected>Select Month</option>';
            reportingMonthSelect.disabled = true;
            if (year && yearMonths[year]) {
                reportingMonthSelect.disabled = false;
                yearMonths[year].forEach(month => {
                    const option = document.createElement('option');
                    option.value = month.value;
                    option.textContent = month.label;
                    reportingMonthSelect.appendChild(option);
                });
            }
        }

        function populateIndicators() {
            indicatorsTableBody.innerHTML = '';
            indicatorsData.forEach((indicatorObj, index) => {
                const row = indicatorsTableBody.insertRow();
                const serialNumberCell = row.insertCell();
                const indicatorCell = row.insertCell();

                serialNumberCell.textContent = index + 1;
                indicatorCell.textContent = indicatorObj.indicator;

                const inputColumns = [
                    "establishment_fsw", "home_fsw", "street_fsw", "virtual_fsw",
                    "msm", "msw",
                    "tg_non_sw", "tg_sw",
                    "other_male", "other_female"
                ];

                inputColumns.forEach(col => {
                    const cell = row.insertCell();
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.classList.add('indicator-input');
                    input.dataset.indicatorIndex = index;
                    input.dataset.column = col;
                    cell.appendChild(input);
                });

                // Add sub-total cells (initially empty)
                row.insertCell().classList.add('subtotal-fsw', 'readonly');
                row.insertCell(); // Empty for MSM
                row.insertCell(); // Empty for MSW
                row.insertCell().classList.add('subtotal-msm', 'readonly');
                row.insertCell(); // Empty for TG Non SW
                row.insertCell(); // Empty for TG SW
                row.insertCell().classList.add('subtotal-tg', 'readonly');
                row.insertCell().classList.add('readonly'); // Other Male
                row.insertCell().classList.add('readonly'); // Other Female
                row.insertCell().classList.add('subtotal-pp', 'readonly');
                row.insertCell().classList.add('grand-total', 'readonly');
            });

            // Add event listeners for input changes to handle calculations and editing
            const indicatorInputs = document.querySelectorAll('#indicators input.indicator-input');
            indicatorInputs.forEach(input => {
                input.addEventListener('input', handleIndicatorInputChange);
                input.addEventListener('focus', () => input.classList.remove('error'));
            });
        }

        function handleIndicatorInputChange(event) {
            const input = event.target;
            input.classList.add('edited');
            if (input.value && !/^\d+$/.test(input.value)) {
                input.classList.add('error');
            } else {
                input.classList.remove('error');
                calculateTotalsForRow(input.closest('tr'));
                calculateGrandTotal();
            }
        }

        function calculateTotalsForRow(row) {
            const inputs = row.querySelectorAll('input.indicator-input');
            let fsw = 0;
            let msm = 0;
            let tg = 0;
            let pp = 0;
            let otherMale = parseInt(inputs[8]?.value || 0);
            let otherFemale = parseInt(inputs[9]?.value || 0);

            for (let i = 0; i < inputs.length; i++) {
                const value = parseInt(inputs[i].value || 0);
                if (i < 4) { // Establishment, Home, Street, Virtual FSW
                    fsw += value;
                } else if (i === 4 || i === 5) { // MSM, MSW
                    msm += value;
                } else if (i === 6 || i === 7) { // TG Non SW, TG SW
                    tg += value;
                }
            }

            pp = otherMale + otherFemale;
            const grandTotal = fsw + msm + tg + pp;

            row.querySelector('.subtotal-fsw').textContent = fsw;
            row.querySelector('.subtotal-msm').textContent = msm;
            row.querySelector('.subtotal-tg').textContent = tg;
            row.querySelector('.subtotal-pp').textContent = pp;
            row.querySelector('.grand-total').textContent = grandTotal;
        }

        function calculateGrandTotal() {
            let grandTotal = 0;
            document.querySelectorAll('#indicators tbody tr').forEach(row => {
                grandTotal += parseInt(row.querySelector('.grand-total').textContent || 0);
            });
            // You might want to display this grand total somewhere outside the table if needed.
            // For now, it's calculated within each row.
        }

        function checkIfAlreadySubmitted() {
            // Placeholder for API call or local storage check
            const district = districtSelect.value;
            const subPartner = subPartnerSelect.value;
            const reportingYear = reportingYearSelect.value;
            const reportingMonth = reportingMonthSelect.value;

            if (district && subPartner && reportingYear && reportingMonth) {
                // Simulate checking if data exists
                const alreadySubmitted = false; // Replace with actual check

                if (alreadySubmitted) {
                    submitBtn.style.display = 'none';
                    editBtn.style.display = 'inline-block';
                    downloadBtn.style.display = 'inline-block';
                    // Optionally, load the existing data into the form
                    // loadSubmittedData(district, subPartner, reportingYear, reportingMonth);
                    disableInputFields();
                } else {
                    submitBtn.style.display = 'inline-block';
                    editBtn.style.display = 'none';
                    updateBtn.style.display = 'none';
                    downloadBtn.style.display = 'none';
                    enableInputFields();
                }
            } else {
                submitBtn.disabled = true;
                editBtn.style.display = 'none';
                updateBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
            }
        }

        function disableInputFields() {
            const selects = document.querySelectorAll('#monthlyLogForm select');
            const inputs = document.querySelectorAll('#indicators input[type="text"]');
            selects.forEach(select => select.disabled = true);
            inputs.forEach(input => input.readOnly = true);
        }

        function enableInputFields() {
            const selects = document.querySelectorAll('#monthlyLogForm select');
            const inputs = document.querySelectorAll('#indicators input[type="text"]');
            selects.forEach(select => select.disabled = false);
            inputs.forEach(input => input.readOnly = false);
        }

        function handleEdit() {
            enableInputFields();
            submitBtn.style.display = 'none';
            editBtn.style.display = 'none';
            updateBtn.style.display = 'inline-block';
            downloadBtn.style.display = 'none';
            const indicatorInputs = document.querySelectorAll('#indicators input[type="text"]');
            indicatorInputs.forEach(input => input.readOnly = false);
            editLogDiv.style.display = 'none';
            editLogList.innerHTML = '';
            const editedInputs = document.querySelectorAll('.edited');
            editedInputs.forEach(input => input.classList.remove('edited'));
        }

        function handleUpdate(event) {
            event.preventDefault();
            // Collect updated data
            const formData = getFormData();
            // Placeholder for API call to update data
            console.log('Updating data:', formData);
            // After successful update, you might want to:
            // - Disable the form again
            // - Show a success message
            // - Update the edit log
            disableInputFields();
            submitBtn.style.display = 'none';
            editBtn.style.display = 'inline-block';
            updateBtn.style.display = 'none';
            downloadBtn.style.display = 'inline-block';
            // Simulate adding to edit log
            const listItem = document.createElement('li');
            listItem.textContent = `Updated on ${new Date().toLocaleString()}`;
            editLogList.appendChild(listItem);
            editLogDiv.style.display = 'block';
        }

        function handleSubmit(event) {
            event.preventDefault();
            if (!monthlyLogForm.checkValidity()) {
                alert('Please fill in all required fields and correct any errors.');
                return;
            }

            const formData = getFormData();
            // Placeholder for API call to submit data
            console.log('Submitting data:', formData);
            // After successful submission, you might want to:
            // - Disable the form
            // - Show a success message
            // - Update the edit log
            disableInputFields();
            submitBtn.disabled = true;
            editBtn.style.display = 'inline-block';
            downloadBtn.style.display = 'inline-block';
            // Simulate adding to edit log
            const listItem = document.createElement('li');
            listItem.textContent = `Submitted on ${new Date().toLocaleString()}`;
            editLogList.appendChild(listItem);
            editLogDiv.style.display = 'block';
        }

        function getFormData() {
            const formData = {
                district: districtSelect.value,
                subPartner: subPartnerSelect.value,
                reportingYear: reportingYearSelect.value,
                reportingMonth: reportingMonthSelect.value,
                indicators: []
            };

            document.querySelectorAll('#indicators tbody tr').forEach(row => {
                const indicatorData = {};
                indicatorData.indicator = row.querySelector('td:nth-child(2)').textContent;
                const inputs = row.querySelectorAll('input.indicator-input');
                const columns = [
                    "establishment_fsw", "home_fsw", "street_fsw", "virtual_fsw",
                    "msm", "msw",
                    "tg_non_sw", "tg_sw",
                    "other_male", "other_female"
                ];
                inputs.forEach((input, index) => {
                    indicatorData[columns[index]] = input.value;
                });
                formData.indicators.push(indicatorData);
            });
            return formData;
        }

        function handleDownload() {
            const formData = getFormData();
            // Placeholder for function to convert formData to Excel and trigger download
            console.log('Downloading data:', formData);
            alert('Download functionality will be implemented here.');
        }

        districtSelect.addEventListener('change', (event) => {
            populateSubPartners(event.target.value);
            reportingMonthSelect.disabled = true;
            reportingMonthSelect.innerHTML = '<option value="" disabled selected>Select Month</option>';
            submitBtn.disabled = !districtSelect.value || !subPartnerSelect.value || !reportingYearSelect.value || !reportingMonthSelect.value;
            checkIfAlreadySubmitted();
        });

        subPartnerSelect.addEventListener('change', () => {
            submitBtn.disabled = !districtSelect.value || !subPartnerSelect.value || !reportingYearSelect.value || !reportingMonthSelect.value;
            checkIfAlreadySubmitted();
        });

        reportingYearSelect.addEventListener('change', (event) => {
            populateMonths(event.target.value);
            submitBtn.disabled = !districtSelect.value || !subPartnerSelect.value || !reportingYearSelect.value || !reportingMonthSelect.value;
            checkIfAlreadySubmitted();
        });

        reportingMonthSelect.addEventListener('change', () => {
            submitBtn.disabled = !districtSelect.value || !subPartnerSelect.value || !reportingYearSelect.value || !reportingMonthSelect.value;
            checkIfAlreadySubmitted();
        });

        monthlyLogForm.addEventListener('submit', handleSubmit);
        editBtn.addEventListener('click', handleEdit);
        updateBtn.addEventListener('click', handleUpdate);
        downloadBtn.addEventListener('click', handleDownload);

        populateSubPartners(districtSelect.value);
        populateMonths(reportingYearSelect.value);
        populateIndicators();
        checkIfAlreadySubmitted(); // Check on initial load
        submitBtn.disabled = true; // Initially disable submit button
    </script>
</body>
</html>
